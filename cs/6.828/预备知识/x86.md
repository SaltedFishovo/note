http://www.logix.cz/michal/doc/i386/ 手册

https://www.fermimn.edu.it/linux/quarta/x86/index.htm 指令集

http://bochs.sourceforge.net/techspec/PORTS.LST 端口

http://ftp.gnu.org/old-gnu/Manuals/ld-2.9.1/html_mono/ld.html  lds

https://www.gnu.org/software/sed/manual/sed.html

### x86保护模式寻址

#### 介绍：

此时我们仅仅单纯的描述保护模式开启后的寻址方式，此时 *Pagging* 功能还未开启。

当保护模式开启后，CPU通过分段硬件，将内存视作一个二维的空间，即分为若干个段。**此时，每产生一个地址，CPU都认为该地址是某个段内的偏移量**，这个时候CPU所产生的地址被称为**逻辑地址**。

CPU通过**段描述符**找到段的基地址，段描述符中存放了段的物理基地址，在32位CPU中，段描述符为8字节，段的物理基地址在段描述符中占了4字节。

内存中存放着一个**全局描述符表**，该表每一个条目是一个段描述符，寄存器 *GDTR* 存储着全局描述符表的物理地址。

实模式下的段寄存器在保护模式下被称为段选择器，而段地址被称为段选择子，段选择子就是描述符表的一个**索引**。

在现代x86架构下，每个段选择器增加了一个程序员不可见的缓存器，该缓存存放了一个段描述符。在保护模式下，将一个段选择子存入段选择器中时，CPU自动将段选择子作为索引，查找段描述符表，将所对应的段描述符加载至该段选择器的缓存中。

> movb $0x8，%ax
>
> movb %ax, %ds

如果实在保护模式下，此时就将段描述符表中第九个描述符加载进了 *ds* 的缓存中。

自此以后，若有以 *ds* 为默认指令前缀的指令访问一个内存单元时，该内存单元的物理地址都会这样产生：**段基地址 + 逻辑地址**

例如：

> movl 0x10000, %eax  #ATT语法中直接给定一个常数视作”直接寻址“

实际上，如果 *ds* 缓存中段基地址部分为0x500000，那么CPU就是将物理地址 *0x501000* 处的4字节加载至寄存器 *eax* 中。如下图，图中 *OFFEST* 就是处理器产生的地址， *BASE ADDRESS* 就是段描述符中的物理基地址，最后相加得出一个在分页硬件未开启情况下的物理地址，如果开启了分页硬件，此时产生的就是虚拟地址。

![image-20210325201448689](C:\Users\26349\AppData\Roaming\Typora\typora-user-images\image-20210325201448689.png)

#### 段描述符：

在分段存储管理机制的保护模式下，每个段由如下三个参数进行定义：段基地址(Base Address)、段界限(Limit)和段属性(Attributes)。

在分段存储管理机制的保护模式下，每个段由如下三个参数进行定义：段基地址(Base Address)、段界限(Limit)和段属性(Attributes)。在ucore中的kern/mm/mmu.h中的struct segdesc 数据结构中有具体的定义。

- 段基地址：规定线性地址空间中段的起始地址。在80386保护模式下，段基地址长32位。因为基地址长度与寻址地址的长度相同，所以任何一个段都可以从32位线性地址空间中的任何一个字节开始，而不象实方式下规定的边界必须被16整除。
- 段界限：规定段的大小。在80386保护模式下，段界限用20位表示，而且段界限可以是以字节为单位或以4K字节为单位。
- 段属性：确定段的各种性质。
  - 段属性中的粒度位（Granularity），用符号G标记。G=0表示段界限以字节位位单位，20位的界限可表示的范围是1字节至1M字节，增量为1字节；G=1表示段界限以4K字节为单位，于是20位的界限可表示的范围是4K
  - 段属性中的粒度位（Granularity），用符号G标记。G=0表示段界限以字节位位单位，20位的界限可表示的范围是1字节至1M字节，增量为1字节；G=1表示段界限以4K字节为单位，于是20位的界限可表示的范围是4K字节至4G字节，增量为4K字节。
  - 类型（TYPE）：用于区别不同类型的描述符。可表示所描述的段是代码段还是数据段，所描述的段是否可读/写/执行，段的扩展方向等。
  - 描述符特权级（Descriptor Privilege Level）（DPL）：用来实现保护机制。
  - 段存在位（Segment-Present bit）：如果这一位为0，则此描述符为非法的，不能被用来实现地址转换。如果一个非法描述符被加载进一个段寄存器，处理器会立即产生异常。图5-4显示 了当存在位为0时，描述符的格式。操作系统可以任意的使用被标识为可用（AVAILABLE）的位。
  - 已访问位（Accessed bit）：当处理器访问该段（当一个指向该段描述符的选择子被加载进一个段寄存器）时，将自动设置访问位。操作系统可清除该位。

![image-20210325200550926](C:\Users\26349\AppData\Roaming\Typora\typora-user-images\image-20210325200550926.png)



#### 全局描述符表寄存器 GDTR： 

 *GDTR* 通过指令 *lgdt addr* 来加载，该寄存器共48位，其中高32位为 *GDT* 的物理基地址，低16位为..，判断段选择子是否有效。

#### 段选择子：

一个段选择子大小为16位，位3-位15段描述符表的索引，位2标识是是全局描述符，还是局部描述符，RPL为特权级。

![image-20210325201228077](C:\Users\26349\AppData\Roaming\Typora\typora-user-images\image-20210325201228077.png)



